(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-166e0db0"],{"1d93":function(e,t,i){"use strict";i.r(t);var a=i("84fa"),n=i("781e");for(var r in n)["default"].indexOf(r)<0&&function(e){i.d(t,e,(function(){return n[e]}))}(r);i("d87b");var s=i("0c7c"),o=Object(s["a"])(n["default"],a["a"],a["b"],!1,null,"7d20902f",null);t["default"]=o.exports},"781e":function(e,t,i){"use strict";i.r(t);var a=i("ff79"),n=i.n(a);for(var r in a)["default"].indexOf(r)<0&&function(e){i.d(t,e,(function(){return a[e]}))}(r);t["default"]=n.a},"84fa":function(e,t,i){"use strict";i.d(t,"a",(function(){return a})),i.d(t,"b",(function(){return n}));var a=function(){var e=this,t=e.$createElement,i=e._self._c||t;return i("el-container",[i("el-aside",{staticClass:"left-tree"},[i("el-input",{attrs:{id:"searchAddIn",placeholder:"搜索"},model:{value:e.inMeasureSearch,callback:function(t){e.inMeasureSearch=t},expression:"inMeasureSearch"}}),i("div",{staticClass:"panel panel-default"},[i("div",{staticClass:"panel-body",staticStyle:{height:"400px","overflow-y":"auto"}},[i("tree",{attrs:{nodes:e.inTreeNodes,setting:e.inTreeSetting},on:{onCreated:e.inTreeCreate}})],1)])],1),i("el-container",[i("el-main",[i("el-form",{ref:"form",attrs:{model:e.form}},[i("el-row",[i("el-col",{attrs:{span:12}},[i("el-form-item",{attrs:{label:"指标名称"}},[i("el-input",{attrs:{id:"inName",placeholder:"请输入指标名称"},model:{value:e.form.measureName,callback:function(t){e.$set(e.form,"measureName",t)},expression:"form.measureName"}})],1)],1),2!=e.addType?i("el-col",{attrs:{span:12}},[i("el-form-item",{attrs:{label:"所属分类"}},[i("el-select",{ref:"folderName",staticStyle:{width:"100%"},attrs:{placeholder:"请选择所属分类"},model:{value:e.form.folderName,callback:function(t){e.$set(e.form,"folderName",t)},expression:"form.folderName"}},[i("el-option",{staticStyle:{width:"100%",height:"200px",overflow:"auto","background-color":"#fff"},attrs:{value:e.form.folderName,label:e.form.folderName}},[i("publictree",{attrs:{setFolderIdAndName:e.setFolderIdAndName,type:2}})],1)],1)],1)],1):e._e()],1),i("el-form-item",{attrs:{label:"指标公式",id:"gongShi"}},[i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){return e.appendText("+")}}},[e._v("+")]),i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){return e.appendText("-")}}},[e._v("-")]),i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){return e.appendText("*")}}},[e._v("*")]),i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){return e.appendText("/")}}},[e._v("/")]),i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){return e.appendText("(")}}},[e._v("(")]),i("el-button",{attrs:{type:"primary",size:"mini"},on:{click:function(t){e.appendText(")")}}},[e._v(")")]),i("textarea",{directives:[{name:"model",rawName:"v-model",value:e.form.code,expression:"form.code"}],ref:"code",attrs:{id:"code"},domProps:{value:e.form.code},on:{input:function(t){t.target.composing||e.$set(e.form,"code",t.target.value)}}})],1),i("el-form-item",{attrs:{label:"指标说明"}},[i("el-input",{attrs:{type:"textarea",id:"inMemo"},model:{value:e.form.inMemo,callback:function(t){e.$set(e.form,"inMemo",t)},expression:"form.inMemo"}})],1)],1)],1),i("el-footer",[i("div",{staticStyle:{float:"right"}},[i("el-button",{attrs:{type:"primary"},on:{click:e.saveDimension}},[e._v("保存")]),i("el-button",{attrs:{type:"primary"},on:{click:e.closeDialog}},[e._v("取消")])],1)])],1),i("el-dialog",{attrs:{"append-to-body":"",title:"选择聚合方式",visible:e.groupDialogVisible,width:"30%"},on:{"update:visible":function(t){e.groupDialogVisible=t}}},[i("el-button-group",[i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addGroup("sum"),e.groupDialogVisible=!1}}},[e._v("合计")]),i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addGroup("count"),e.groupDialogVisible=!1}}},[e._v("计数")]),i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addGroup("avg"),e.groupDialogVisible=!1}}},[e._v("平均值")]),i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addGroup("max"),e.groupDialogVisible=!1}}},[e._v("最大值")]),i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addGroup("min"),e.groupDialogVisible=!1}}},[e._v("最小值")]),i("el-button",{attrs:{type:"primary"},on:{click:function(t){e.addGroup("distinct"),e.groupDialogVisible=!1}}},[e._v("差异计数")])],1)],1),i("el-dialog",{attrs:{title:"条件设置",visible:e.queryBuilderDialogVisible,width:"30%","append-to-body":!0},on:{"update:visible":function(t){e.queryBuilderDialogVisible=t}}},[e.queryBuilderDialogVisible?i("myQueryBuilder",{ref:"myQueryBuilder",attrs:{columns:e.queryRules,data:e.form.inFilterShowObj.queryBuilderJson}}):e._e(),i("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[i("el-button",{on:{click:function(t){e.queryBuilderDialogVisible=!1}}},[e._v("取消")]),i("el-button",{attrs:{type:"primary"},on:{click:e.queryCondition}},[e._v("确定")])],1)],1)],1)},n=[]},b8c1:function(e,t,i){},d87b:function(e,t,i){"use strict";i("b8c1")},ff79:function(e,t,i){"use strict";var a=i("4ea4");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,i("7f7f"),i("4917"),i("a481"),i("3b2b");a(i("b775"));var n=a(i("1157")),r=(i("5c96"),a(i("56b3")));i("a7be"),i("a8d9"),i("f9d4"),i("693d");var s=i("2d2b"),o=a(i("ddae")),l=a(i("c4e0")),d={name:"addderiveIn",props:["type","addType","inMeasureUuid","parentUuid","nowAnalysisRegionId"],components:{tree:function(e){return i.e("chunk-46cc1826").then(function(){var t=[i("aa39")];e.apply(null,t)}.bind(this)).catch(i.oe)},publictree:function(e){return i.e("chunk-48ddfab7").then(function(){var t=[i("b25b")];e.apply(null,t)}.bind(this)).catch(i.oe)},Colorpicker:o.default,myQueryBuilder:l.default},data:function(){return{form:{measureName:"",folderName:"",code:"",inMemo:"",inFilterShow:"",inFilterShowObj:{queryBuilderJson:{},backGroundColor:"#000000",fontColor:"#000000",sql:""}},queryRules:{},inTree:null,inTreeNodes:null,inTreeSetting:null,inMeasureSearch:"",queryBuilderDialogVisible:!1,editor:null,editData:null,listInId:[],treeIds:"",pbScopeUuid:"",treePath:"",auditorOrauditorgan:null,derObj:{indicatrixId:"",indicatrixName:"",res:{}},gindicatrixId:null,gindicatrixName:null,ginduuid:null,groupDialogVisible:!1,isOrgManager:sessionStorage.getItem("isOrgManager"),isInManager:sessionStorage.getItem("isInManager"),analysisRegionId:this.nowAnalysisRegionId}},mounted:function(){this.initData(),this.initIndicatrixZtree()},created:function(){},methods:{inTreeCreate:function(e){var t=this;this.inTree=e,this.inTree.expandAll(!0),(0,s.fuzzySearch)(this.inTree,"#searchAddIn",null,!1);for(var i=this.inTree.getNodes(),a=this.inTree.transformToArray(i),r=0;r<a.length;r++)"2"!=a[r].indicatrixType&&"4"!=a[r].indicatrixType&&"3"!=a[r].indicatrixType||this.inTree.hideNode(a[r]);if(null!=this.inMeasureUuid&&""!=this.inMeasureUuid){var o=this.contextUrl+"/InMeasure/validationRel";n.default.post(o,{list:this.editor.getValue(),inMeasureId:""},(function(e){t.getDimRelIn(e)}),"json")}},initData:function(){this.editor=r.default.fromTextArea(this.$refs.code,{lineNumbers:!0,indentUnit:4,styleActiveLine:!0,matchBrackets:!0,mode:"htmlmixed",lineWrapping:!0});var e=this;if(this.editor.on("change",(function(t,i){e.codeMirrorValueEdit(t,i)})),""==this.inMeasureUuid);else{var t=decodeURI(this.inMeasureUuid);this.antiDisplayIndicatrixData(t)}},initIndicatrixZtree:function(){var e=this.contextUrl+"/InFolder/getIndicatrixTree",t=this;n.default.post(e,{},(function(e){var i=e,a={check:{enable:!1,chkboxType:{Y:"s",N:"ps"},drag:{autoExpandTrigger:!0,prev:!0,inner:!0,next:!0}},data:{key:{name:"name"},simpleData:{enable:!0,idKey:"id",pIdKey:"pid"}},async:{enable:!1},callback:{beforeDrag:t.beforeDrag,beforeDrop:t.beforeDrop,onDrop:t.onDrop,onAsyncSuccess:t.onAsyncSuccess,onAsyncError:t.onAsyncError,beforeAsync:t.beforeAsync},view:{selectedMulti:!1,fontCss:t.getFontCss},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1}};t.inTreeSetting=a,t.inTreeNodes=i}),"json")},onclick:function(e,t,i){this.inTree.expandNode(i)},saveDimension:function(){void 0==this.inMeasureUuid||""===this.inMeasureUuid?this.addIn():this.editIn()},addIn:function(){if(this.verIsNoNull()){var e=this.getuuid(),t=(0,n.default)("#inName").val(),i=(0,n.default)("#inName").val(),a=new RegExp("^[A-Za-z一-龥]+$");if(a.test(i)){var r={inMeasureUuid:e,measureName:i,measureType:decodeURI(this.type),inFolderUuid:this.treeIds,measureMemo:(0,n.default)("#inMemo").val(),measureGroup:"",measureFormula:this.editor.getValue(),tableUuid:"",isDelete:0,createTime:"",updateTime:"",createPersonUuid:"",createPersonName:"",measurePath:this.treePath,measureAlias:i,pbScopeUuid:this.pbScopeUuid,inFilterShow:JSON.stringify(this.form.inFilterShowObj)},s=this.contextUrl+"/InMeasure/verMeasureAlias",o=this;if(1==this.addType)n.default.post(s,{measureAlias:t},(function(t){if(1==t.state){var i=o.contextUrl+"/InMeasure/insertDeriveIn";n.default.post(i,{inMeasurem:JSON.stringify(r)},(function(t){1==t.state&&o.$emit("loadInMeasueData",2,o.analysisRegionId,e,!0),o.closeDialog()}),"json")}else o.$message(t.message)}),"json");else{var l=o.contextUrl+"/InMeasure/insertDeriveIn";n.default.post(l,{inMeasurem:JSON.stringify(r)},(function(t){1==t.state&&2==o.addType&&(o.$message(t.message),o.$emit("loadInMeasueData",2,o.analysisRegionId,e,!0)),o.closeDialog()}),"json")}}else this.$message("请输入合法名称")}},verIsNoNull:function(){var e=(0,n.default)("#inName").val(),t=this.editor.getValue(),i=(0,n.default)("#inMemo").val();return""==e||null==e||void 0==e?(this.$message("请输入指标名称。"),!1):e.length>50?(this.$message("指标名称不能大于50！"),!1):1==this.addType&&""==this.treeIds&&void 0==this.inMeasureUuid?(this.$message("请选择分类！"),!1):""==t||null==t||void 0==t?(this.$message("请输入派生公式！"),!1):!(i.length>2e3)||(this.$message("指标说明不能大于2000！"),!1)},editIn:function(){var e=this;if(e.verIsNoNull()){var t=(0,n.default)("#inName").val();if(t!=this.editData.measureAlias){var i=e.contextUrl+"/InMeasure/verMeasureAlias";n.default.post(i,{measureAlias:t},(function(t){1==t.state?e.update():e.$message(t.message)}),"json")}else e.update()}},update:function(){this.editData.measureName=(0,n.default)("#inName").val(),this.editData.measureMemo=(0,n.default)("#inMemo").val(),this.editData.measureAlias=(0,n.default)("#inName").val(),this.editData.measureFormula=this.editor.getValue(),this.editData.measurePath=this.treePath,""!=this.treeIds&&(this.editData.inFolderUuid=this.treeIds,this.editData.pbScopeUuid=this.pbScopeUuid,this.editData.measurePath=this.treePath),this.editData.inFilterShow=JSON.stringify(this.form.inFilterShowObj);var e=(0,n.default)("#inName").val(),t=new RegExp("^[A-Za-z一-龥]+$");if(t.test(e)){var i=this.contextUrl+"/InMeasure/updateDeriveIn",a=this;n.default.post(i,{inMeasure:JSON.stringify(this.editData)},(function(e){if(1==e.state){if(2==a.addType){"编辑了临时指标:'{0}'".format((0,n.default)("#inName").val());a.addOperLogByParam(a.log_module,a.log_add,a.log_info);var t,i=decodeURI(a.type),r="modify";a.$emit("delAnalysisListDownIn",a.parentUuid,a.analysisRegionId,a.inMeasureUuid,i,"true","",r,(function(e){t=e})),a.$emit("loadInMeasueData",2,a.analysisRegionId,a.inMeasureUuid,!0,t)}a.closeDialog()}else a.$message(e.message)}),"json")}else this.$message("请输入合法名称")},antiDisplayIndicatrixData:function(e){var t=this,i="";i=2==this.addType?this.contextUrl+"/InMeasure/selectTemDeriveIn":this.contextUrl+"/InMeasure/selectDeriveIn",n.default.post(i,{inMeasureUuid:e},(function(e){e.inFilterShowObj=JSON.parse(e.inFilterShow),t.form=e,t.editData=e,t.treePath=t.editData.measurePath,(0,n.default)("#inName").attr("value",e.measureName),(0,n.default)("#folderName").attr("value",e.folderName),(0,n.default)("#inMemo").text(e.measureMemo),t.setValue2CM(t.editor,e.measureFormula),console.log(t.form.inFilterShowObj)}),"json")},setValue2CM:function(e,t){var i=0,a="",n=0;while(i<t.length)"["==t[i]?(i+=1,this.appendValue2CM(this.editor,a,n),a="",n=1):"]"==t[i]?(i+=1,this.appendValue2CM(this.editor,a,n),a="",n=0):a+=t[i++];this.appendValue2CM(this.editor,a,0)},appendValue2CM:function(e,t,i){var a=this.editor.getCursor({line:this.editor.lineCount(),ch:99999});if(1==i){this.editor.replaceRange("["+t+"]",a,a);var r="";t.indexOf("distinct")>-1&&(t=t.replace("distinct ",""));var s=this.getCharBetweenString(t),o=this;if(n.default.ajax({url:this.contextUrl+"/InMeasure/selectDeriveIn",async:!1,data:{inMeasureUuid:s},type:"post",dataType:"json",success:function(e){r=e.measureName}}),void 0==r)this.editor.replaceRange(t,a,a);else{this.listInId.push(s);var l=t.replace(s,"").replace("(","").replace(")",""),d=o.updateGroupDisplay(l,r),u=(0,n.default)("<span class='selected' id='["+t+"]'>"+d+"</span>").get(0),c=this.editor.getCursor({line:this.editor.lineCount(),ch:99999});this.editor.markText(a,c,{replacedWith:u,className:"selected"})}}else this.editor.replaceRange(t,a,a)},closeDialog:function(){this.$emit("closeAddderiveinDialog")},addCalculation:function(e,t){var i=this,a=this.contextUrl+"/InMeasure/validationRel";n.default.post(a,{list:this.editor.getValue(),inMeasureId:e},(function(a){i.groupDialogVisible=!0,i.derObj.indicatrixId=e,i.derObj.indicatrixName=t,i.derObj.res=a}),"json")},addGroup:function(e){var t=this.derObj.indicatrixName,i=this.derObj.indicatrixId,a="["+e+"("+i+")]";"distinct"==e&&(a="[count ("+e+" "+i+")]");var r=this.updateGroupDisplay(e,t),s=this.derObj.res,o=(0,n.default)("<span class ='selected' id = '"+i+"'>"+r+"</span>").get(0),l=this.editor.getCursor(),d={ch:l.ch+a.length,line:l.line,sticky:null};this.editor.replaceRange(a,l,l),this.editor.markText(l,d,{replacedWith:o,className:"selected"}),this.listInId.push(i),this.getDimRelIn(s)},updateGroup:function(e,t,i,a){var r="["+e+"{"+t+"}"+a+"^"+i+"]",s=this.editor.getCursor();this.editor.replaceRange(r,s,s);var o=/\[(.+?)\]/g,l=this.editor.getSearchCursor(o);while(1){var d=l.findNext();if(!d)break;this.$message(d[0]);var u=/\}(.+?)\]/,c=d[0].match(u)[1],f=(0,n.default)("<div class='tag-select tag-info' title='"+i+"'><span>"+e+"("+i+")</span><i class='icon-down' onclick='addDeriveIn.inTriangle(\""+t+'","'+i+'","'+c+"\")'></i></div>").get(0);this.editor.markText(l.from(),l.to(),{replacedWith:f,className:"paramBlock1"})}},updateGroup1:function(e){var t=this.gindicatrixId,i=this.gindicatrixName,a=(gbline,gbch,this.getuuid()),r="[count{"+t+"}"+a+"]",s=this.editor.getCursor();this.editor.replaceRange(r,s,s);var o=(0,n.default)("<div class='tag-select tag-info' title='"+i+"'><span>"+e+"("+i+")</span><i class='icon-down' onclick='addDeriveIn.inTriangle(\""+t+'","'+i+'","'+a+"\")'></i></div>").get(0);this.editor.markText(s,cursor,{replacedWith:o,className:"selected"})},replaceWidget:function(e,t,i){var a=/\[(.+?)\]/g,n=this.editor.getSearchCursor(a);while(1){var r=n.findNext();if(!r)break;this.$message(r);var s="<div>sss</div>";this.editor.markText(n.from(),n.to(),{replacedWith:s,className:"paramBlock1"})}},getDimRelIn:function(e){var t=this.inTree.getNodes(),i=this.inTree.transformToArray(t);if(0==e.length)for(var a=0;a<i.length;a++)"indicatrix"==i[a].type&&this.inTree.hideNode(i[a]);for(a=0;a<i.length;a++){var n=e.indexOf(i[a].id);-1==n&&"indicatrix"==i[a].type&&this.inTree.hideNode(i[a])}},appendText:function(e){this.editor.replaceSelection(e)},beforeDrag:function(e,t){if("folder"==t[0].type)return!1;for(var i=0,a=t.length;i<a;i++)if(!1===t[i].drag)return!1;return!0},beforeDrop:function(e,t,i,a){return!1},onDrop:function(e,t,i,a,n){var r=i[0].id,s=i[0].name,o=i[0];this.calculationPosition("gongShi")&&this.addCalculation(r,s,o)},calculationPosition:function(e){var t=(0,n.default)("#"+e).offset().left,i=(0,n.default)("#"+e).offset().top,a=(0,n.default)("#"+e).width(),r=(0,n.default)("#"+e).height(),s=t+a,o=i+r;return event.clientX>t&&event.clientX<s&&event.clientY>i&&event.clientY<o},getFontCss:function(e,t){return t.highlight?{color:"#FF8000","font-weight":"bold"}:{color:"#333","font-weight":"normal"}},codeMirrorValueEdit:function(e,t){var i=this;n.default.each(this.listInId,(function(e,t){if(null!=t){var a=i.editor.getValue();if(-1==a.indexOf(t)){delete i.listInId[e];var r=i.contextUrl+"/InMeasure/validationRelOne";n.default.post(r,{list:i.editor.getValue()},(function(e){i.showTreeNode(e)}),"json")}}}))},showTreeNode:function(e){var t=this.inTree.getNodes(),i=this.inTree.transformToArray(t);if(0==e.length)for(var a=0;a<i.length;a++)"indicatrix"==i[a].type&&this.inTree.showNode(i[a]);for(a=0;a<i.length;a++){var n=e.indexOf(i[a].id);0==n&&"indicatrix"==i[a].type&&this.inTree.showNode(i[a])}},setFolderIdAndName:function(e,t,i,a,n,r){this.form.folderName=a,this.treeIds=e,this.pbScopeUuid=n,this.treePath=i,this.auditorOrauditorgan=r},inTriangle:function(e,t,i){this.gindicatrixId=e,this.gindicatrixName=t,this.ginduuid=i,event.stopPropagation(),this.showMenu(event.clientX,event.clientY,"group")},showMenu:function(e,t,i){var a=this;(0,n.default)("#"+i).show(),t+=document.body.scrollTop,e+=document.body.scrollLeft,(0,n.default)("#"+i).css({top:t+"px",left:e+"px",visibility:"visible"}),(0,n.default)("body").bind("mousedown",(function(){a.onBodyMouseDownHideMenu(event,i)}))},updateGroupDisplay:function(e,t){return"sum"==e?"合计("+t+")":"count"==e?"计数("+t+")":"max"==e?"最大值("+t+")":"min"==e?"最小值("+t+")":"avg"==e?"平均值("+t+")":"distinct"==e?"差异计数("+t+")":t},setQueryBuilderRules:function(){var e=[],t={columnType:"int"};t.columnName=this.form.measureName,e.push(t),this.queryRules.columnList=e},setFilterShow:function(){""!==this.form.inName?this.queryBuilderDialogVisible=!0:this.$message("请输入指标名称。")},queryCondition:function(){var e=this.$refs.myQueryBuilder.getSelectSql();this.form.inFilterShowObj.sql=e.sql,this.form.inFilterShowObj.queryBuilderJson=e.queryJson,this.queryBuilderDialogVisible=!1}}};t.default=d}}]);